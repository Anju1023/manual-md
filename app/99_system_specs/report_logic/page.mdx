import { Callout } from 'nextra/components';

# 📝 帳票出力マクロの仕様 (Report Logic)

操作シートのボタンから呼び出される、各帳票作成マクロの内部ロジック解説です。
すべてのマクロは `Application.ScreenUpdating = False` で高速化され、`frmProgress` で進捗を表示する共通仕様となっています。

## 🏭 製造数・集計系

### CB 製造数合計出力 / クリエイト製造数合計出力

各店舗のシートからデータを収集し、集計シート（`CB製造数` 等）に書き出します。

- **集計ロジック:**
  - `Scripting.Dictionary` を使用。キーは「商品名」。
  - 各店舗シートの `3列目(月)` 〜 `16列目(日)` の値を加算。
- **対象シート:**
  - `先頭` 〜 `末尾` (または `クリエ先頭` 〜 `クリエ末尾`) の間のシートをループ処理。
  - `A5` 行目から `End(xlUp)` までをデータ範囲として取得。

### 消費期限チェック表出力 (ラベル出し)

ラベラー担当者が使用する、消費期限と個数のチェックリストです。

- **データソース:** 集計済みの `CB製造数` シート。
- **クラス使用:** `ClsLabel` クラスを使用して、曜日ごとの個数や期限情報を整理。
- **期限計算:**
  - `商品データ` テーブルの `期限` 列を参照。
  - `期限 <= 1` の場合は `+1` (翌日) とするロジックが含まれています。
- **表示制御:** 1 週間分の合計が `0` の商品はリストから除外されます。

## 🍞 工程表 (生地・成形)

### 冷凍生地出し / スクラッチ生地出し / 並べる表

製造スタッフが使用する工程表です。商品属性 (`Frozen`, `Display`) によって出力先が振り分けられます。

- **計算ロジック (重要):**
  - マスタ (`ClsItem`) の `OutputQty` (生地出し) や `DisplayQty` (並べる) メソッドを使用。
  - **生地出し数:** `製造数 * 何個入 * 生地数` (切り上げ)
  - **日付シフト:** `納品日 - 生地出し(or並べ)日数` で、作業日を逆算して集計。
- **マージ処理:**
  - 「商品名」の `1/2` や `1本` などのサイズ違いを取り除き、**「親名称 (BaseName)」** で合算しています。
  - 例: `プレミアム食パン` と `プレミアム食パン 1/2` → `プレミアム食パン` として合計。

## 🛒 発注・納品系

### 商品別シート出力 (ローゼン / クリエイト)

店舗ごとの仕分けリストを作成します。**新しいブックを生成** して保存します。

- **保存先:** `CB商品データ.xlsm` と同じフォルダ内の `\商品ごとの表\`
- **並び替え:**
  - データの取得順ではなく、**店舗マスターの「店舗番号」順** に並び替えるロジック (バブルソート) が実装されています。
- **印刷設定:** 全シートに対して、余白・倍率・ヘッダー（日時スタンプ）等の設定をループ処理で適用します。

### 発注表作成 & 仕入先別出力

原材料の発注書を作成します。

1. **所要量計算:**
   - `製造数` シートの合計 × `レシピ` テーブルの使用量
2. **発注数算出:**
   - 総所要量 ÷ `材料マスター` の入数 (切り上げ)
3. **出力:**
   - `発注` シートに一覧を出力後、`仕入先別発注表` シートに仕入先ごとのブロックに分けて転記。
   - `発注並び順` シートの設定に従って並び順を制御。
